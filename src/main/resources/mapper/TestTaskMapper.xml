<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ngtesting.platform.dao.TestTaskDao" >

    <select id="listByPlan" resultMap="testTaskWithAssignees">
        SELECT task.*,
          usr.nickname userName,
          project.name projectName,
          caseProject.name caseProjectName,
          env.name envName,
          assignee.id assigneeId, assignee.nickname assigneeNickname, assignee.avatar assigneeAvatar

        FROM TstTask task

        JOIN TstUser usr ON task.userId = usr.id
        JOIN TstProject project ON task.projectId = project.id
        JOIN TstProject caseProject ON task.caseProjectId = caseProject.id
        LEFT JOIN TstEnv env ON task.envId = env.id

        LEFT JOIN TstTaskAssigneeRelation r on r.taskId = task.id
        LEFT JOIN TstUser assignee on r.assigneeId = assignee.id

        WHERE task.planId=#{planId}
        AND task.deleted != TRUE AND task.disabled != TRUE
        ORDER BY task.createTime ASC
    </select>

    <select id="listCaseIds" resultType="int">
        SELECT o.id
        FROM TstCaseInTask o

        WHERE o.taskId=#{id}
        AND o.deleted != TRUE AND o.disabled != TRUE
        ORDER BY o.pId, o.id
    </select>

    <resultMap type="TstTask" id="testTask" autoMapping="true"></resultMap>

    <resultMap type="TstTask" id="testTaskWithAssignees" extends="testTask">
        <collection property="assignees" ofType="TstUser">
            <id property="id" column="assigneeId" />
            <result property="nickname" column="assigneeNickname" />
            <result property="avatar" column="assigneeAvatar" />
        </collection>
    </resultMap>

</mapper>
